name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (will be written to setup.py)'
        required: true
      dry_run:
        description: 'Publish to TestPyPI (true) or PyPI (false)'
        required: false
        default: 'false'
      create_tag:
        description: 'Create and push tag v<version> automatically'
        required: false
        default: 'true'
  push:
    tags:
      - 'v*'

jobs:
  build-and-publish:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # need full history for tagging & rebasing
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Bump version in setup.py
        id: bump_version
        run: |
          INPUT_VERSION='${{ inputs.version }}'
          echo "Updating version to $INPUT_VERSION"
          sed -i.bak -E "s/version='[0-9A-Za-z._-]+'/version='${INPUT_VERSION}'/" setup.py
          grep -E "version='${INPUT_VERSION}'" setup.py || (echo "::error::Failed to update version"; exit 1)
          rm -f setup.py.bak
          echo "version=${INPUT_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Sync with remote main
        run: |
          git fetch origin main
          # Try fast-forward; if not possible, rebase
          git merge --ff-only origin/main || git rebase origin/main || echo "::warning::Rebase failed; continuing (may cause push rejection)"

      - name: Commit version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add setup.py
          git commit -m "chore: bump version to ${{ inputs.version }}" || echo "Nothing to commit"
          # Ensure local is up to date before push (handles race where new commits landed after checkout)
          git pull --rebase --autostash origin main || echo "::warning::Pull rebase failed; attempting push anyway"
          git push

      - name: Create tag
        if: ${{ inputs.create_tag == 'true' }}
        run: |
          git tag "v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Build distribution (sdist + wheel)
        run: |
          python -m build

      - name: List artifacts
        run: ls -1 dist

      - name: Publish (PyPI or TestPyPI)
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "Dry run to TestPyPI";
            twine upload --repository-url https://test.pypi.org/legacy/ dist/*
          else
            twine upload dist/*
          fi
        if: ${{ github.event_name == 'workflow_dispatch' }}

      - name: Publish on tag (PyPI)
        if: ${{ startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push' }}
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m build
          twine upload dist/*
